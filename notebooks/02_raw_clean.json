{"cells":[{"cell_type":"markdown","id":"lKBx_5jBt87s","metadata":{"id":"lKBx_5jBt87s"},"source":["# 02 ‚Äî RAW ‚Üí CLEAN | ISPRA Catasto Rifiuti\n","\n","Trasforma i CSV RAW ISPRA (dettaglio comunale)  \n","in un dataset CLEAN multi-anno salvato su Drive.\n","\n","Input:\n","data/raw/ispra_catasto_rifiuti/<anno>/*.csv\n","\n","Output:\n","data/clean/ispra_catasto_rifiuti/ispra_catasto_rifiuti_clean.parquet\n","\n","Regole:\n","- RAW intoccabile\n","- Standardizza colonne\n","- Parsing numeri IT (\".\", \",\", \"%\", \"-\")\n","- Nessuna analisi qui\n","\n","Notebook Colab: https://colab.research.google.com/drive/1lllppEVTNT5A5vNu2XXe2qOmQAwfVEfn?usp=sharing\n","\n","Output Drive: https://drive.google.com/drive/folders/1vQ3a_jjUElW3khZtcWY7BySia4G6EDXZ?usp=drive_link\n","\n","## Problema nei raw\n","\n","I file ISPRA includono nella stessa tabella:\n","\n","- Dati dei singoli comuni\n","- Dati di aggregazioni/consorzi intercomunali\n","\n","Questi record aggregati possono generare valori pro capite non realistici (es. > 10.000 kg/ab) se non filtrati correttamente.\n","\n","## Soluzione adottata\n","\n","Filtriamo la colonna `Dato riferito a`, mantenendo solo: Comune\n","ed escludendo:\n","\n","- \"Aggregazione: ...\"\n","- \"Vedi aggregazione: ...\"\n","\n","## Risultato\n","\n","Il dataset clean contiene esclusivamente dati comunali coerenti, pronti per la costruzione del MART analitico (03_clean_mart).\n","\n","## Autori\n","\n","- Gabriele Sala ‚Äî sviluppo notebook\n","- Matteo Cavo ‚Äî fix filtro aggregazioni ISPRA e validazione dataset\n","\n"]},{"cell_type":"code","execution_count":null,"id":"iPLZ8bmft87y","metadata":{"id":"iPLZ8bmft87y"},"outputs":[],"source":["# 0) Setup\n","import re\n","import numpy as np\n","import pandas as pd\n","from pathlib import Path\n","\n","pd.set_option('display.max_columns', 200)\n"]},{"cell_type":"code","execution_count":null,"id":"5Mn1Z413t871","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"5Mn1Z413t871","outputId":"c50f9d51-8892-4d41-bcdf-3fecab31bc5f","executionInfo":{"status":"ok","timestamp":1771313776654,"user_tz":-60,"elapsed":19065,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["# 1) Mount Drive (Colab)\n","from google.colab import drive\n","drive.mount('/content/drive')\n"]},{"cell_type":"code","execution_count":null,"id":"S19rFFKit871","metadata":{"id":"S19rFFKit871"},"outputs":[],"source":["# 2) Parametri progetto\n","BASE_PATH = Path('/content/drive/MyDrive/DataCivicLab/data')  # <-- cambia se serve\n","\n","RAW_PATH   = BASE_PATH / 'raw/ispra_catasto_rifiuti'\n","CLEAN_PATH = BASE_PATH / 'clean/ispra_catasto_rifiuti'\n","\n","YEARS = [2019, 2020, 2021, 2022, 2023]  # es: [2020, 2021, 2022, 2023]\n"]},{"cell_type":"markdown","id":"YUKIDECat872","metadata":{"id":"YUKIDECat872"},"source":["## Loader RAW robusto (ISPRA)\n","ISPRA spesso mette una **riga titolo** prima dell'header e valori con **TAB**. Qui:\n","- troviamo l'header vero\n","- leggiamo tutto come stringa\n","- ripuliamo TAB/spazi in colonne chiave\n"]},{"cell_type":"code","execution_count":null,"id":"jA5L4V26t872","metadata":{"id":"jA5L4V26t872"},"outputs":[],"source":["def load_raw_year(year: int) -> pd.DataFrame:\n","    files = list((RAW_PATH / str(year)).glob(\"*.csv\"))\n","    if not files:\n","        raise FileNotFoundError(f\"Nessun file CSV per {year} in {RAW_PATH/str(year)}\")\n","    path = files[0]\n","\n","    # leggi righe\n","    with open(path, \"r\", encoding=\"utf-8\", errors=\"replace\") as f:\n","        lines = f.readlines()\n","\n","    # trova header\n","    header_idx = None\n","    for i, line in enumerate(lines[:100]):\n","        if line.strip().startswith(\"IstatComune;Regione;Provincia;Comune\"):\n","            header_idx = i\n","            break\n","    if header_idx is None:\n","        raise ValueError(\"Header ISPRA non trovato\")\n","\n","    header = [c.strip() for c in lines[header_idx].strip().split(\";\")]\n","\n","    rows = []\n","    for line in lines[header_idx + 1:]:\n","        line = line.rstrip(\"\\n\")\n","        if not line.strip():\n","            continue\n","\n","        parts = [p.replace(\"\\t\", \"\").strip() for p in line.split(\";\")]\n","\n","        # forza rettangolo: pad o truncate\n","        if len(parts) < len(header):\n","            parts += [\"\"] * (len(header) - len(parts))\n","        elif len(parts) > len(header):\n","            parts = parts[:len(header)]\n","\n","        rows.append(parts)\n","\n","    df = pd.DataFrame(rows, columns=header)\n","    return df\n"]},{"cell_type":"markdown","id":"hVFXqVO6t873","metadata":{"id":"hVFXqVO6t873"},"source":["## Profiler rapido (controllo allineamento)\n","Se la prima colonna non sembra un codice ISTAT (6‚Äì8 cifre), il RAW √® **shiftato** e va corretto in lettura.\n"]},{"cell_type":"code","execution_count":null,"id":"y2Nv-s4xt874","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":254},"id":"y2Nv-s4xt874","outputId":"04373226-fae3-4a02-c52a-207ad2c6ee71","executionInfo":{"status":"ok","timestamp":1771313834978,"user_tz":-60,"elapsed":2643,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["first_col = IstatComune\n","istat_like_ratio = 1.0\n","examples = ['01001001', '01001002', '01001003', '01001004', '01001006', '01001007', '01001008', '01001009', '01001010', '01001011']\n"]},{"output_type":"execute_result","data":{"text/plain":["  IstatComune   Regione Provincia   Comune Popolazione Dato riferito a  \\\n","0    01001001  Piemonte    Torino   AGLIE'        2621          Comune   \n","1    01001002  Piemonte    Torino  AIRASCA        3598          Comune   \n","\n","  Frazione umida(1) (t) Verde (t) Carta e cartone (t) Vetro (t) Legno (t)  \\\n","0               255,275   363,247              92,683    95,948    34,824   \n","1               174,489   140,355             239,377   100,730   255,501   \n","\n","  Metallo (t) Plastica (t) RAEE (t) Tessili (t) Selettiva (t)  \\\n","0      14,370       81,440   11,324      12,044         0,931   \n","1      18,048      155,374    9,759      10,980         3,134   \n","\n","  Rifiuti da C e D (t) Pulizia stradale a recupero (t)  \\\n","0                6,643                           2,860   \n","1               10,801                           7,760   \n","\n","  Ingombranti misti a recupero (t) Altro (t) Totale RD (t)  \\\n","0                           34,280     1,995     1.007,864   \n","1                          110,507         -     1.236,815   \n","\n","  Ingombranti a smaltimento (t) Indifferenziato (t) Totale RU (t)  \\\n","0                             -             549,186     1.557,050   \n","1                             -             734,180     1.970,995   \n","\n","  Percentuale RD (%)  \n","0             64,73%  \n","1             62,75%  "],"text/html":["\n","  <div id=\"df-d7b89a7f-0df2-49e1-9f69-c62151e1d56e\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>IstatComune</th>\n","      <th>Regione</th>\n","      <th>Provincia</th>\n","      <th>Comune</th>\n","      <th>Popolazione</th>\n","      <th>Dato riferito a</th>\n","      <th>Frazione umida(1) (t)</th>\n","      <th>Verde (t)</th>\n","      <th>Carta e cartone (t)</th>\n","      <th>Vetro (t)</th>\n","      <th>Legno (t)</th>\n","      <th>Metallo (t)</th>\n","      <th>Plastica (t)</th>\n","      <th>RAEE (t)</th>\n","      <th>Tessili (t)</th>\n","      <th>Selettiva (t)</th>\n","      <th>Rifiuti da C e D (t)</th>\n","      <th>Pulizia stradale a recupero (t)</th>\n","      <th>Ingombranti misti a recupero (t)</th>\n","      <th>Altro (t)</th>\n","      <th>Totale RD (t)</th>\n","      <th>Ingombranti a smaltimento (t)</th>\n","      <th>Indifferenziato (t)</th>\n","      <th>Totale RU (t)</th>\n","      <th>Percentuale RD (%)</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>01001001</td>\n","      <td>Piemonte</td>\n","      <td>Torino</td>\n","      <td>AGLIE'</td>\n","      <td>2621</td>\n","      <td>Comune</td>\n","      <td>255,275</td>\n","      <td>363,247</td>\n","      <td>92,683</td>\n","      <td>95,948</td>\n","      <td>34,824</td>\n","      <td>14,370</td>\n","      <td>81,440</td>\n","      <td>11,324</td>\n","      <td>12,044</td>\n","      <td>0,931</td>\n","      <td>6,643</td>\n","      <td>2,860</td>\n","      <td>34,280</td>\n","      <td>1,995</td>\n","      <td>1.007,864</td>\n","      <td>-</td>\n","      <td>549,186</td>\n","      <td>1.557,050</td>\n","      <td>64,73%</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>01001002</td>\n","      <td>Piemonte</td>\n","      <td>Torino</td>\n","      <td>AIRASCA</td>\n","      <td>3598</td>\n","      <td>Comune</td>\n","      <td>174,489</td>\n","      <td>140,355</td>\n","      <td>239,377</td>\n","      <td>100,730</td>\n","      <td>255,501</td>\n","      <td>18,048</td>\n","      <td>155,374</td>\n","      <td>9,759</td>\n","      <td>10,980</td>\n","      <td>3,134</td>\n","      <td>10,801</td>\n","      <td>7,760</td>\n","      <td>110,507</td>\n","      <td>-</td>\n","      <td>1.236,815</td>\n","      <td>-</td>\n","      <td>734,180</td>\n","      <td>1.970,995</td>\n","      <td>62,75%</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-d7b89a7f-0df2-49e1-9f69-c62151e1d56e')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-d7b89a7f-0df2-49e1-9f69-c62151e1d56e button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-d7b89a7f-0df2-49e1-9f69-c62151e1d56e');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","variable_name":"raw0"}},"metadata":{},"execution_count":5}],"source":["def alignment_check(df: pd.DataFrame, n=30):\n","    first_col = df.columns[0]\n","    s = df[first_col].astype(str).head(n)\n","\n","    extracted = (\n","        s.str.replace(\"\\t\", \"\", regex=False)\n","         .str.strip()\n","         .str.extract(r\"(\\d{6,8})\")[0]\n","    )\n","\n","    ratio = extracted.notna().mean()\n","    examples = extracted.fillna(s).tolist()[:10]\n","    return first_col, ratio, examples\n","\n","# --- USO ---\n","raw0 = load_raw_year(YEARS[0])\n","first_col, ratio, ex = alignment_check(raw0)\n","\n","print(\"first_col =\", first_col)\n","print(\"istat_like_ratio =\", ratio)\n","print(\"examples =\", ex)\n","\n","raw0.head(2)\n","\n"]},{"cell_type":"markdown","id":"H4egMdpvt874","metadata":{"id":"H4egMdpvt874"},"source":["## Standardizzazione colonne + parsing numeri (IT)\n"]},{"cell_type":"code","execution_count":null,"id":"DcFlXemut875","metadata":{"id":"DcFlXemut875"},"outputs":[],"source":["def standardize_columns(df: pd.DataFrame) -> pd.DataFrame:\n","    df = df.copy()\n","    df.columns = (\n","        df.columns.astype(str)\n","        .str.strip()\n","        .str.lower()\n","        .str.replace('\\t', '', regex=False)\n","        .str.replace(' ', '_')\n","        .str.replace('%', 'perc')\n","        .str.replace(r'[()]', '', regex=True)\n","        .str.replace(r'[^a-z0-9_]+', '', regex=True)\n","    )\n","    return df\n","\n","def parse_number_it(x):\n","    if x is None or (isinstance(x, float) and np.isnan(x)):\n","        return np.nan\n","    s = str(x).strip()\n","    if s == '' or s == '-' or s.lower() == 'nan':\n","        return np.nan\n","    s = s.replace('%', '').strip()\n","    # FIX: se c'e' virgola, il punto e' SEMPRE separatore migliaia (formato IT)\n","    # es: 1.557,050 -> rimuovi punto -> 1557,050 -> virgola in punto -> 1557.050\n","    # es: 1.007,864 -> 1007.864\n","    if ',' in s:\n","        s = s.replace('.', '')   # rimuovi punti (migliaia)\n","        s = s.replace(',', '.')  # virgola -> punto decimale\n","    else:\n","        # nessuna virgola: punto multiplo = migliaia (es. 1.042.158)\n","        # punto singolo = decimale anglosassone (es. 154.511) -> lascia stare\n","        if s.count('.') > 1:\n","            s = s.replace('.', '')\n","    s = re.sub(r'[^0-9.\\-]', '', s)\n","    try:\n","        return float(s)\n","    except ValueError:\n","        return np.nan\n"]},{"cell_type":"code","execution_count":null,"id":"g9Hdd36Et875","metadata":{"id":"g9Hdd36Et875"},"outputs":[],"source":["def clean_catasto(df: pd.DataFrame, year: int) -> pd.DataFrame:\n","    \"\"\"Pulisce e standardizza i dati ISPRA, filtrando solo comuni reali.\"\"\"\n","    # FILTRO CRITICO: Rimuovi dati aggregati/consorzi\n","    # ISPRA include righe con \"Vedi aggregazione:\" o \"Aggregazione:\"\n","    # che sono dati di CONSORZI, non di singoli comuni\n","    if \"Dato riferito a\" in df.columns:\n","        before = len(df)\n","        # Mantieni SOLO righe con \"Comune\" (esclude aggregazioni)\n","        df = df[df[\"Dato riferito a\"].astype(str).str.strip() == \"Comune\"].copy()\n","        after = len(df)\n","        filtered = before - after\n","        if filtered > 0:\n","            print(f\"  ‚ö†Ô∏è Anno {year}: Filtrate {filtered} righe di aggregazioni/consorzi\")\n","\n","    df = standardize_columns(df)\n","    df['anno'] = year\n","\n","    # rename robusto (post-standardizzazione)\n","    rename_map = {\n","        'istatcomune': 'codice_comune_istat',\n","        'totale_ru_t': 'rifiuti_urbani_tonnellate',\n","        'totale_rd_t': 'raccolta_differenziata_tonnellate',\n","        'percentuale_rd_perc': 'raccolta_differenziata_perc',\n","        'dato_riferito_a': 'dato_riferito_a',\n","    }\n","    df = df.rename(columns={k:v for k,v in rename_map.items() if k in df.columns})\n","\n","    if \"codice_comune_istat\" in df.columns:\n","        df[\"codice_comune_istat\"] = (\n","            df[\"codice_comune_istat\"].astype(str)\n","            .str.replace(\"\\t\", \"\", regex=False)\n","            .str.strip()\n","            .str.extract(r\"(\\d{6,8})\")[0]\n","            .str.zfill(6)\n","        )\n","\n","\n","    # colonne numeriche (tonnellate/perc + popolazione)\n","    numeric_cols = [c for c in df.columns if c.endswith('_t') or c.endswith('_tonnellate') or c.endswith('_perc')]\n","    if 'popolazione' in df.columns:\n","        numeric_cols.append('popolazione')\n","\n","    for col in numeric_cols:\n","        df[col] = df[col].map(parse_number_it)\n","\n","    return df\n"]},{"cell_type":"markdown","id":"lVkkj_YMt876","metadata":{"id":"lVkkj_YMt876"},"source":["## Esecuzione multi-anno + salvataggio CLEAN e meta json\n"]},{"cell_type":"code","execution_count":null,"id":"W8KuJX9Et876","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"W8KuJX9Et876","outputId":"ac6e2fbc-02ed-4489-a050-783950ea6b55","executionInfo":{"status":"ok","timestamp":1771313850115,"user_tz":-60,"elapsed":5691,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Processing 2019\n","  ‚ö†Ô∏è Anno 2019: Filtrate 194 righe di aggregazioni/consorzi\n","Processing 2020\n","  ‚ö†Ô∏è Anno 2020: Filtrate 185 righe di aggregazioni/consorzi\n","Processing 2021\n","  ‚ö†Ô∏è Anno 2021: Filtrate 195 righe di aggregazioni/consorzi\n","Processing 2022\n","  ‚ö†Ô∏è Anno 2022: Filtrate 183 righe di aggregazioni/consorzi\n","Processing 2023\n","  ‚ö†Ô∏è Anno 2023: Filtrate 142 righe di aggregazioni/consorzi\n"]},{"output_type":"execute_result","data":{"text/plain":["(38631, 26)"]},"metadata":{},"execution_count":8}],"source":["dfs = []\n","for y in YEARS:\n","    print('Processing', y)\n","    raw = load_raw_year(y)\n","    # check veloce: la prima colonna deve sembrare codice\n","    fc, r, _ = alignment_check(raw)\n","    if r < 0.5:\n","        print('‚ö†Ô∏è Warning: possibile shift in lettura. first_col=', fc, 'istat_like_ratio=', r)\n","    clean = clean_catasto(raw, y)\n","    dfs.append(clean)\n","\n","df_clean = pd.concat(dfs, ignore_index=True, sort=False)\n","df_clean.shape\n"]},{"cell_type":"code","execution_count":null,"id":"diag_nan_check","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"diag_nan_check","executionInfo":{"status":"ok","timestamp":1771313857517,"user_tz":-60,"elapsed":27,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}},"outputId":"63ed668f-a7e5-410c-eb4c-cfee07c03907"},"outputs":[{"output_type":"stream","name":"stdout","text":["=== NaN per colonna chiave ===\n","\n","rifiuti_urbani_tonnellate: 0/38631 NaN (0.0%)\n","  ‚Üí per anno:\n","anno\n","2019    0\n","2020    0\n","2021    0\n","2022    0\n","2023    0\n","\n","raccolta_differenziata_tonnellate: 103/38631 NaN (0.3%)\n","  ‚Üí per anno:\n","anno\n","2019    28\n","2020    21\n","2021    18\n","2022    22\n","2023    14\n","\n","raccolta_differenziata_perc: 103/38631 NaN (0.3%)\n","  ‚Üí per anno:\n","anno\n","2019    28\n","2020    21\n","2021    18\n","2022    22\n","2023    14\n","\n","popolazione: 0/38631 NaN (0.0%)\n","  ‚Üí per anno:\n","anno\n","2019    0\n","2020    0\n","2021    0\n","2022    0\n","2023    0\n"]}],"source":["# üîç DIAGNOSTICA NaN per colonne chiave\n","key_cols = ['rifiuti_urbani_tonnellate', 'raccolta_differenziata_tonnellate', 'raccolta_differenziata_perc', 'popolazione']\n","print('=== NaN per colonna chiave ===')\n","for col in key_cols:\n","    if col in df_clean.columns:\n","        null_count = df_clean[col].isna().sum()\n","        total = len(df_clean)\n","        print(f'\\n{col}: {null_count}/{total} NaN ({null_count/total*100:.1f}%)')\n","        print('  ‚Üí per anno:')\n","        print(df_clean.groupby('anno')[col].apply(lambda x: x.isna().sum()).to_string())\n"]},{"cell_type":"code","execution_count":null,"id":"2GY97cA0t876","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"2GY97cA0t876","outputId":"70fbfcd8-c881-49b6-d8b7-d1720f468ad9","executionInfo":{"status":"ok","timestamp":1771313868231,"user_tz":-60,"elapsed":7,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"execute_result","data":{"text/plain":["['codice_comune_istat',\n"," 'regione',\n"," 'provincia',\n"," 'comune',\n"," 'popolazione',\n"," 'rifiuti_urbani_tonnellate',\n"," 'raccolta_differenziata_tonnellate',\n"," 'raccolta_differenziata_perc',\n"," 'anno']"]},"metadata":{},"execution_count":10}],"source":["# sanity check sulle colonne chiave\n","cols_check = ['codice_comune_istat','regione','provincia','comune','popolazione',\n","              'rifiuti_urbani_tonnellate','raccolta_differenziata_tonnellate','raccolta_differenziata_perc','anno']\n","[c for c in cols_check if c in df_clean.columns]\n"]},{"cell_type":"code","execution_count":null,"id":"nO9fWzU4t877","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":383},"id":"nO9fWzU4t877","outputId":"7f83a3d3-f25f-44f5-ff99-1fb0f36c6a16","executionInfo":{"status":"ok","timestamp":1771313871569,"user_tz":-60,"elapsed":41,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"execute_result","data":{"text/plain":["  codice_comune_istat  popolazione  rifiuti_urbani_tonnellate  \\\n","0            01001001       2621.0                   1557.050   \n","1            01001002       3598.0                   1970.995   \n","2            01001003        441.0                    285.584   \n","3            01001004       1644.0                    695.424   \n","4            01001006       6426.0                   3659.691   \n","5            01001007        248.0                    154.511   \n","6            01001008      16945.0                   7706.060   \n","7            01001009       2041.0                    848.910   \n","8            01001010        492.0                    179.769   \n","9            01001011        846.0                    298.670   \n","\n","   raccolta_differenziata_tonnellate  raccolta_differenziata_perc  anno  \n","0                           1007.864                        64.73  2019  \n","1                           1236.815                        62.75  2019  \n","2                            112.624                        39.44  2019  \n","3                            503.335                        72.38  2019  \n","4                           2954.946                        80.74  2019  \n","5                             59.651                        38.61  2019  \n","6                           5281.208                        68.53  2019  \n","7                            607.653                        71.58  2019  \n","8                            114.112                        63.48  2019  \n","9                            185.480                        62.10  2019  "],"text/html":["\n","  <div id=\"df-c5e6fde9-dbef-4fb6-b618-d2115f1f290d\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>codice_comune_istat</th>\n","      <th>popolazione</th>\n","      <th>rifiuti_urbani_tonnellate</th>\n","      <th>raccolta_differenziata_tonnellate</th>\n","      <th>raccolta_differenziata_perc</th>\n","      <th>anno</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>01001001</td>\n","      <td>2621.0</td>\n","      <td>1557.050</td>\n","      <td>1007.864</td>\n","      <td>64.73</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>01001002</td>\n","      <td>3598.0</td>\n","      <td>1970.995</td>\n","      <td>1236.815</td>\n","      <td>62.75</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>01001003</td>\n","      <td>441.0</td>\n","      <td>285.584</td>\n","      <td>112.624</td>\n","      <td>39.44</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>01001004</td>\n","      <td>1644.0</td>\n","      <td>695.424</td>\n","      <td>503.335</td>\n","      <td>72.38</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>01001006</td>\n","      <td>6426.0</td>\n","      <td>3659.691</td>\n","      <td>2954.946</td>\n","      <td>80.74</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>5</th>\n","      <td>01001007</td>\n","      <td>248.0</td>\n","      <td>154.511</td>\n","      <td>59.651</td>\n","      <td>38.61</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>6</th>\n","      <td>01001008</td>\n","      <td>16945.0</td>\n","      <td>7706.060</td>\n","      <td>5281.208</td>\n","      <td>68.53</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>7</th>\n","      <td>01001009</td>\n","      <td>2041.0</td>\n","      <td>848.910</td>\n","      <td>607.653</td>\n","      <td>71.58</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>8</th>\n","      <td>01001010</td>\n","      <td>492.0</td>\n","      <td>179.769</td>\n","      <td>114.112</td>\n","      <td>63.48</td>\n","      <td>2019</td>\n","    </tr>\n","    <tr>\n","      <th>9</th>\n","      <td>01001011</td>\n","      <td>846.0</td>\n","      <td>298.670</td>\n","      <td>185.480</td>\n","      <td>62.10</td>\n","      <td>2019</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-c5e6fde9-dbef-4fb6-b618-d2115f1f290d')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-c5e6fde9-dbef-4fb6-b618-d2115f1f290d button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-c5e6fde9-dbef-4fb6-b618-d2115f1f290d');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","    </div>\n","  </div>\n"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"dataframe","summary":"{\n  \"name\": \"df_clean[[c for c in ['codice_comune_istat','popolazione','rifiuti_urbani_tonnellate','raccolta_differenziata_tonnellate','raccolta_differenziata_perc','anno'] if c in df_clean\",\n  \"rows\": 10,\n  \"fields\": [\n    {\n      \"column\": \"codice_comune_istat\",\n      \"properties\": {\n        \"dtype\": \"string\",\n        \"num_unique_values\": 10,\n        \"samples\": [\n          \"01001010\",\n          \"01001002\",\n          \"01001007\"\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"popolazione\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 5073.907190497061,\n        \"min\": 248.0,\n        \"max\": 16945.0,\n        \"num_unique_values\": 10,\n        \"samples\": [\n          492.0,\n          3598.0,\n          248.0\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"rifiuti_urbani_tonnellate\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 2366.238498147321,\n        \"min\": 154.511,\n        \"max\": 7706.06,\n        \"num_unique_values\": 10,\n        \"samples\": [\n          179.769,\n          1970.995,\n          154.511\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"raccolta_differenziata_tonnellate\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 1676.6820161498058,\n        \"min\": 59.651,\n        \"max\": 5281.208,\n        \"num_unique_values\": 10,\n        \"samples\": [\n          114.112,\n          1236.815,\n          59.651\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"raccolta_differenziata_perc\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 13.571732223837735,\n        \"min\": 38.61,\n        \"max\": 80.74,\n        \"num_unique_values\": 10,\n        \"samples\": [\n          63.48,\n          62.75,\n          38.61\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    },\n    {\n      \"column\": \"anno\",\n      \"properties\": {\n        \"dtype\": \"number\",\n        \"std\": 0,\n        \"min\": 2019,\n        \"max\": 2019,\n        \"num_unique_values\": 1,\n        \"samples\": [\n          2019\n        ],\n        \"semantic_type\": \"\",\n        \"description\": \"\"\n      }\n    }\n  ]\n}"}},"metadata":{},"execution_count":11}],"source":["df_clean[[c for c in ['codice_comune_istat','popolazione','rifiuti_urbani_tonnellate','raccolta_differenziata_tonnellate','raccolta_differenziata_perc','anno'] if c in df_clean.columns]].head(10)\n"]},{"cell_type":"code","execution_count":null,"id":"aVfFIt4kt877","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"aVfFIt4kt877","outputId":"d728a530-33be-4b58-dc15-49e628ee1f98","executionInfo":{"status":"ok","timestamp":1771313876315,"user_tz":-60,"elapsed":1541,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/ispra_catasto_rifiuti_clean.parquet\n"]}],"source":["# Salva su Drive\n","CLEAN_PATH.mkdir(parents=True, exist_ok=True)\n","out_path = CLEAN_PATH / 'ispra_catasto_rifiuti_clean.parquet'\n","\n","df_clean.to_parquet(out_path, index=False)\n","print('Saved:', out_path)\n"]},{"cell_type":"code","execution_count":null,"id":"tcUsBI31yj55","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"tcUsBI31yj55","outputId":"8bfd4d8b-7ce9-484b-f1c2-1d2250f9c718","executionInfo":{"status":"ok","timestamp":1771313933041,"user_tz":-60,"elapsed":7233,"user":{"displayName":"Matteo Cavo","userId":"15727220103966895763"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/metadata.json\n","  ‚ö†Ô∏è Anno 2019: Filtrate 194 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/profile_2019.json\n","  ‚ö†Ô∏è Anno 2020: Filtrate 185 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/profile_2020.json\n","  ‚ö†Ô∏è Anno 2021: Filtrate 195 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/profile_2021.json\n","  ‚ö†Ô∏è Anno 2022: Filtrate 183 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/profile_2022.json\n","  ‚ö†Ô∏è Anno 2023: Filtrate 142 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/profile_2023.json\n","  ‚ö†Ô∏è Anno 2019: Filtrate 194 righe di aggregazioni/consorzi\n","  ‚ö†Ô∏è Anno 2020: Filtrate 185 righe di aggregazioni/consorzi\n","  ‚ö†Ô∏è Anno 2021: Filtrate 195 righe di aggregazioni/consorzi\n","  ‚ö†Ô∏è Anno 2022: Filtrate 183 righe di aggregazioni/consorzi\n","  ‚ö†Ô∏è Anno 2023: Filtrate 142 righe di aggregazioni/consorzi\n","Saved: /content/drive/MyDrive/DataCivicLab/data/clean/ispra_catasto_rifiuti/_meta/schema_diff.json\n"]}],"source":["import json\n","import datetime as dt\n","from datetime import datetime\n","from pathlib import Path\n","\n","def safe_json(v):\n","    # converte roba numpy/pandas in json-friendly\n","    if isinstance(v, (np.integer,)):\n","        return int(v)\n","    if isinstance(v, (np.floating,)):\n","        return float(v)\n","    if v is None:\n","        return None\n","    return v\n","\n","def df_profile(df, year: int, alignment_tuple=None, sample_rows=3):\n","    # null % per colonna\n","    null_pct = (df.isna().mean() * 100).round(2).to_dict()\n","\n","    # esempi valori (prime 3 non-null)\n","    examples = {}\n","    for c in df.columns:\n","        vals = df[c].dropna().astype(str).head(3).tolist()\n","        examples[c] = vals\n","\n","    # dtypes\n","    dtypes = {c: str(df[c].dtype) for c in df.columns}\n","\n","    prof = {\n","        \"year\": year,\n","        \"rows\": int(df.shape[0]),\n","        \"cols\": int(df.shape[1]),\n","        \"columns\": list(df.columns),\n","        \"dtypes\": dtypes,\n","        \"null_pct\": {k: safe_json(v) for k, v in null_pct.items()},\n","        \"examples\": examples,\n","        \"head_rows\": df.head(sample_rows).to_dict(orient=\"records\"),\n","    }\n","\n","    if alignment_tuple is not None:\n","        first_col, ratio, ex = alignment_tuple\n","        prof[\"alignment_check\"] = {\n","            \"first_col\": first_col,\n","            \"istat_like_ratio\": float(ratio),\n","            \"examples\": ex,\n","        }\n","\n","    # mini stats numeriche (se presenti)\n","    num_cols = [c for c in df.columns if pd.api.types.is_numeric_dtype(df[c])]\n","    if num_cols:\n","        desc = df[num_cols].describe().to_dict()\n","        # json-friendly\n","        for k in desc:\n","            desc[k] = {kk: safe_json(vv) for kk, vv in desc[k].items()}\n","        prof[\"numeric_describe\"] = desc\n","\n","    return prof\n","\n","# --- PARAMETRI OUTPUT ---\n","META_DIR = CLEAN_PATH / \"_meta\"          # cartella meta vicino al clean\n","META_DIR.mkdir(parents=True, exist_ok=True)\n","\n","# --- 1) METADATA dataset (stabile) ---\n","dataset_meta = {\n","    \"dataset_id\": \"ispra_catasto_rifiuti__dettaglio_comunale\",\n","    \"source_owner\": \"ISPRA\",\n","    \"source_name\": \"Catasto Rifiuti ‚Äì Produzione e raccolta differenziata su scala comunale\",\n","    \"granularity\": \"Comune\",\n","    \"years\": YEARS,\n","    \"raw_path\": str(RAW_PATH),\n","    \"clean_path\": str(CLEAN_PATH),\n","    \"clean_file\": \"ispra_catasto_rifiuti_clean.parquet\",\n","    \"generated_at_utc\": dt.datetime.now(dt.timezone.utc).isoformat(),\n","    \"notes\": [\n","        \"RAW: CSV per anno; separatore ';'; riga titolo prima dell'header\",\n","        \"Parsing numeri IT: migliaia '.' + decimali ',' + percentuali con '%' + '-' come missing\",\n","    ],\n","}\n","\n","with open(META_DIR / \"metadata.json\", \"w\", encoding=\"utf-8\") as f:\n","    json.dump(dataset_meta, f, ensure_ascii=False, indent=2)\n","\n","print(\"Saved:\", META_DIR / \"metadata.json\")\n","\n","# --- 2) PROFILE per anno (diagnostica) ---\n","for y in YEARS:\n","    raw = load_raw_year(y)\n","    align = alignment_check(raw)  # usa il profiler robusto\n","\n","    # puoi scegliere se profilare RAW o CLEAN (io consiglio entrambi)\n","    clean = clean_catasto(raw, y)\n","\n","    raw_prof = df_profile(raw, y, alignment_tuple=align)\n","    clean_prof = df_profile(clean, y)\n","\n","    out = {\n","        \"year\": y,\n","        \"raw_profile\": raw_prof,\n","        \"clean_profile\": clean_prof,\n","    }\n","\n","    out_path = META_DIR / f\"profile_{y}.json\"\n","    with open(out_path, \"w\", encoding=\"utf-8\") as f:\n","        json.dump(out, f, ensure_ascii=False, indent=2)\n","\n","    print(\"Saved:\", out_path)\n","def schema_signature(df):\n","    return set(df.columns)\n","\n","profiles = {}\n","for y in YEARS:\n","    raw = load_raw_year(y)\n","    clean = clean_catasto(raw, y)\n","    profiles[y] = schema_signature(clean)\n","\n","diffs = {}\n","ys = sorted(YEARS)\n","for i in range(1, len(ys)):\n","    a, b = ys[i-1], ys[i]\n","    diffs[f\"{a}_to_{b}\"] = {\n","        \"added\": sorted(list(profiles[b] - profiles[a])),\n","        \"removed\": sorted(list(profiles[a] - profiles[b])),\n","    }\n","\n","with open(META_DIR / \"schema_diff.json\", \"w\", encoding=\"utf-8\") as f:\n","    json.dump(diffs, f, ensure_ascii=False, indent=2)\n","\n","print(\"Saved:\", META_DIR / \"schema_diff.json\")\n"]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"name":"python","version":"3.12"}},"nbformat":4,"nbformat_minor":5}